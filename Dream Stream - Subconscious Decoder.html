<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dream Stream - Subconscious Decoder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
  <!-- å­—ä½“ï¼šDela Gothic One (æ¢¦å¹»æ ‡é¢˜) + Quicksand (åœ†æ¶¦æ­£æ–‡) -->
  <link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=Quicksand:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Quicksand', sans-serif; background-color: #2e0249; color: #f3e8ff; }
    h1, h2, .dream-font { font-family: 'Dela Gothic One', cursive; }
    
    /* æ¶²æ€èƒŒæ™¯åŠ¨ç”» */
    .lava-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
      background: linear-gradient(180deg, #2e0249 0%, #570a57 50%, #a91079 100%);
    }
    
    .blob {
      position: absolute;
      background: #ff00cc;
      border-radius: 50%;
      filter: blur(40px);
      opacity: 0.7;
      animation: float 20s infinite ease-in-out alternate;
    }
    .blob:nth-child(1) { width: 400px; height: 400px; top: -100px; left: -100px; background: #581c87; animation-delay: 0s; }
    .blob:nth-child(2) { width: 300px; height: 300px; top: 40%; right: -50px; background: #a21caf; animation-delay: -5s; }
    .blob:nth-child(3) { width: 350px; height: 350px; bottom: -50px; left: 20%; background: #ec4899; animation-delay: -10s; }
    
    @keyframes float {
      0% { transform: translate(0, 0) scale(1); }
      50% { transform: translate(30px, 50px) scale(1.1); }
      100% { transform: translate(-20px, -30px) scale(0.9); }
    }

    /* ç»ç’ƒå¡ç‰‡ */
    .dream-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      border-radius: 24px;
    }

    /* è¾“å…¥æ¡†æ ·å¼ */
    .dream-input {
      background: rgba(0, 0, 0, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      color: white;
      transition: all 0.3s;
    }
    .dream-input:focus {
      outline: none;
      background: rgba(0, 0, 0, 0.3);
      border-color: #f0abfc;
      box-shadow: 0 0 20px rgba(240, 171, 252, 0.2);
    }

    /* æŒ‰é’®åŠ¨ç”» */
    .btn-dream {
      background: linear-gradient(90deg, #a91079, #ff00cc);
      border: none;
      color: white;
      position: relative;
      overflow: hidden;
      transition: all 0.3s;
    }
    .btn-dream::before {
      content: '';
      position: absolute;
      top: 0; left: -100%;
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      transition: 0.5s;
    }
    .btn-dream:hover::before {
      left: 100%;
    }
    .btn-dream:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(169, 16, 121, 0.4);
    }

    /* é€‰ä¸­çŠ¶æ€ */
    .filter-btn.active {
      background-color: #f0abfc;
      color: #2e0249;
      font-weight: bold;
    }
  </style>
</head>
<body class="min-h-screen p-4 sm:p-8 relative overflow-x-hidden selection:bg-fuchsia-300 selection:text-purple-900">

  <!-- æ¶²æ€èƒŒæ™¯ -->
  <div class="lava-container">
    <div class="blob"></div>
    <div class="blob"></div>
    <div class="blob"></div>
  </div>

  <div class="max-w-2xl mx-auto relative z-10 pt-10">
    
    <!-- Header -->
    <div class="text-center mb-12 animate-fade-in-up">
      <div class="inline-block mb-2 text-2xl animate-bounce">ğŸŒ™</div>
      <h1 class="text-5xl md:text-7xl text-white mb-4 tracking-wide drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">
        DREAM STREAM
      </h1>
      <p class="text-fuchsia-200 text-lg font-medium bg-purple-900/30 inline-block px-6 py-2 rounded-full backdrop-blur-sm border border-white/10">
        Unlock the secrets of your subconscious mind.
      </p>
    </div>

    <!-- Main Card -->
    <div class="dream-card p-6 md:p-10 relative overflow-hidden">
      
      <!-- è£…é¥°å…‰æ•ˆ -->
      <div class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full blur-2xl -mr-10 -mt-10"></div>

      <!-- å‰©ä½™æ¬¡æ•° -->
      <div class="flex justify-between items-center mb-8">
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 bg-fuchsia-400 rounded-full animate-pulse"></div>
          <span class="text-xs font-bold uppercase tracking-widest text-fuchsia-200">System Awake</span>
        </div>
        <div class="text-xs bg-black/20 px-3 py-1 rounded-full border border-white/10 text-fuchsia-100">
          Visions Left: <span id="remaining" class="font-bold">--</span>
        </div>
      </div>

      <!-- æ¨¡å¼é€‰æ‹© (Filters) -->
      <div class="mb-6">
        <label class="block text-sm font-bold text-fuchsia-100 mb-3 uppercase tracking-wider text-center">Select Interpretation Lens</label>
        <div class="flex justify-center gap-2 flex-wrap">
          <button onclick="setMode('mystical')" id="mode-mystical" class="filter-btn active px-4 py-2 rounded-xl border border-white/20 hover:bg-white/10 transition-colors text-sm">ğŸ”® Mystical</button>
          <button onclick="setMode('psych')" id="mode-psych" class="filter-btn px-4 py-2 rounded-xl border border-white/20 hover:bg-white/10 transition-colors text-sm">ğŸ§  Psychological</button>
          <button onclick="setMode('unhinged')" id="mode-unhinged" class="filter-btn px-4 py-2 rounded-xl border border-white/20 hover:bg-white/10 transition-colors text-sm">ğŸ¤ª Unhinged</button>
        </div>
      </div>

      <!-- è¾“å…¥åŒºåŸŸ -->
      <div class="mb-8">
        <textarea
          id="question"
          rows="4"
          placeholder="I was flying over a city made of cheese, but my teeth started falling out..."
          spellcheck="false"
          class="dream-input w-full p-5 text-lg placeholder-white/30 resize-none"
        ></textarea>
        <div class="text-right mt-2 text-xs text-white/40">
          Be descriptive. The void listens.
        </div>
      </div>

      <!-- é”™è¯¯æç¤º -->
      <div id="error" class="hidden mb-6 p-4 bg-red-500/20 border border-red-400/50 rounded-xl text-red-100 text-sm font-bold text-center backdrop-blur-sm">
        ğŸš« Nightmare Detected: <span id="errorMsg"></span>
      </div>

      <!-- æŒ‰é’® -->
      <button
        id="consultBtn"
        class="btn-dream w-full py-4 rounded-xl font-bold text-xl uppercase tracking-widest shadow-lg flex justify-center items-center gap-3"
      >
        <span id="btnText">Decode Dream</span>
        <div id="spinner" class="hidden w-5 h-5 border-2 border-white/50 border-t-white rounded-full animate-spin"></div>
      </button>

      <!-- è¾“å‡ºåŒºåŸŸ -->
      <div id="output" class="hidden mt-10 animate-fade-in-up">
        
        <div class="flex items-center justify-center gap-4 mb-6">
          <div class="h-px bg-white/20 w-16"></div>
          <span class="text-fuchsia-300 font-bold uppercase text-sm tracking-widest">Interpretation</span>
          <div class="h-px bg-white/20 w-16"></div>
        </div>

        <div class="bg-black/20 rounded-2xl p-6 border border-white/10 prose prose-invert prose-p:text-fuchsia-50 prose-strong:text-fuchsia-300 max-w-none shadow-inner">
          <div id="result" class="leading-relaxed"></div>
        </div>

        <!-- å¹¸è¿æ•°å­—å½©è›‹ -->
        <div class="mt-6 flex flex-col items-center">
          <span class="text-[10px] uppercase tracking-widest text-white/40 mb-2">Cosmic Lucky Numbers</span>
          <div id="luckyNumbers" class="flex gap-3 font-mono text-lg font-bold text-fuchsia-300">
            <!-- JS ç”Ÿæˆ -->
          </div>
        </div>

        <div class="mt-8 text-center">
          <button onclick="resetApp()" class="text-sm text-white/50 hover:text-white transition-colors border-b border-white/20 hover:border-white pb-1">
            Wake Up & Dream Again
          </button>
        </div>

      </div>

    </div>
    
    <div class="text-center mt-12 opacity-30 text-xs uppercase tracking-[0.3em]">
      Project: Somnium â€¢ v3.0
    </div>

  </div>

  <!-- Fingerprint Lib -->
  <script src="/js/fingerprint.js"></script>

  <script>
    let currentMode = 'mystical';

    function setMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`mode-${mode}`).classList.add('active');
    }

    function resetApp() {
      document.getElementById('question').value = '';
      document.getElementById('output').classList.add('hidden');
      document.getElementById('error').classList.add('hidden');
      
      const btn = document.getElementById('consultBtn');
      btn.disabled = false;
      document.getElementById('btnText').innerText = 'Decode Dream';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Tool ID Logic
    function getToolId() {
      return new Promise((resolve) => {
        const isInIframe = window.self !== window.top;
        if (isInIframe) {
          let received = false;
          window.addEventListener('message', (e) => {
            if (e.data && e.data.type === 'TOOL_ID') {
              received = true;
              resolve(e.data.toolId);
            }
          });
          setTimeout(() => { if (!received) resolve(getToolIdFromUrl()); }, 3000);
        } else {
          resolve(getToolIdFromUrl());
        }
      });
    }

    function getToolIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('toolId') ? parseInt(params.get('toolId')) : null;
    }

    // Fingerprint
    function generateFingerprint() {
      try {
        if (typeof FP !== 'undefined') return FP.getDeviceId();
        throw new Error('FP lib missing');
      } catch (e) {
        const key = 'dream_stream_fallback';
        let id = localStorage.getItem(key);
        if (!id) {
          id = 'dream-' + Math.random().toString(36).substr(2);
          try { localStorage.setItem(key, id); } catch(err){}
        }
        return id;
      }
    }

    // API
    async function checkUsage(toolId) {
      try {
        const fp = generateFingerprint();
        const res = await fetch(`/api/usage/check?toolId=${toolId}&fingerprint=${fp}`);
        const data = await res.json();
        if (!data.allowed) {
          alert('Your mind is exhausted. Sleep on it and return tomorrow.');
          return false;
        }
        document.getElementById('remaining').innerText = data.remaining === -1 ? 'âˆ' : data.remaining;
        return true;
      } catch (e) {
        document.getElementById('remaining').innerText = '--';
        return true;
      }
    }

    async function recordUsage(toolId) {
      const fp = generateFingerprint();
      await fetch('/api/usage/record', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ toolId: toolId, fingerprint: fp })
      });
    }

    // Content Check
    function checkContentRelevance(userInput) {
      const input = userInput.toLowerCase();
      // å…è®¸æè¿°å™©æ¢¦ï¼Œä½†å±è”½æç«¯æš´åŠ›/éæ³•å†…å®¹
      const blackList = ['rape', 'child abuse', 'pedophile', 'terrorist plan', 'bomb'];
      
      for (const word of blackList) {
        if (input.includes(word)) return { allowed: false, reason: "That's too dark even for the subconscious. Restricted." };
      }
      if (input.length < 5) return { allowed: false, reason: "The dream is too foggy. Describe more details." };
      return { allowed: true };
    }

    // Main Logic
    let TOOL_ID = null;
    const elements = {
      btn: document.getElementById('consultBtn'),
      input: document.getElementById('question'),
      output: document.getElementById('output'),
      result: document.getElementById('result'),
      error: document.getElementById('error'),
      errorMsg: document.getElementById('errorMsg'),
      btnText: document.getElementById('btnText'),
      spinner: document.getElementById('spinner'),
      luckyNumbers: document.getElementById('luckyNumbers')
    };

    (async () => {
      TOOL_ID = await getToolId();
      if (TOOL_ID) await checkUsage(TOOL_ID);
    })();

    elements.btn.onclick = async () => {
      const text = elements.input.value.trim();
      if (!text) {
        elements.errorMsg.innerText = "The void is empty. Type your dream.";
        elements.error.classList.remove('hidden');
        return;
      }
      
      const check = checkContentRelevance(text);
      if (!check.allowed) {
        elements.errorMsg.innerText = check.reason;
        elements.error.classList.remove('hidden');
        return;
      }

      if (!TOOL_ID) TOOL_ID = await getToolId();
      if (!TOOL_ID || !(await checkUsage(TOOL_ID))) return;

      // Loading
      elements.error.classList.add('hidden');
      elements.btn.disabled = true;
      elements.btnText.innerText = 'ENTERING R.E.M. CYCLE...';
      elements.spinner.classList.remove('hidden');
      elements.output.classList.add('hidden');

      // Funny timeout
      const longWaitTimer = setTimeout(() => {
        elements.btnText.innerText = 'CONSULTING FREUD...';
      }, 4000);

      try {
        const fp = generateFingerprint();
        
        let promptStyle = "";
        if (currentMode === 'mystical') {
            promptStyle = "Mystical, spiritual, astrology-vibe. Focus on omens, future predictions, and cosmic energy.";
        } else if (currentMode === 'psych') {
            promptStyle = "Psychological, Freudian, Jungian. Focus on subconscious desires, repressed fears, and childhood trauma (but keep it light).";
        } else {
            promptStyle = "Unhinged, Gen Z meme style. Treat the dream as a chaotic brainrot episode. Use slang like 'fever dream', 'core core'.";
        }

        const res = await fetch('/api/ai/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [
              {
                role: 'system',
                content: `You are 'Dream Stream', a dream interpreter.
                
                Task: Interpret the user's dream based on the selected style: ${currentMode}.
                Style Guide: ${promptStyle}
                
                Output Format:
                1. **The Meaning**: A paragraph interpreting the dream.
                2. **The Vibe**: A 1-sentence summary of the dream's energy.
                
                Keep it entertaining, roughly 100-150 words. Do NOT be overly medical or serious.`
              },
              { role: 'user', content: text }
            ],
            temperature: 0.9,
            maxTokens: 2000,
            fingerprint: fp
          })
        });

        if (!res.ok) throw new Error('Woke up too soon. Connection lost.');
        const data = await res.json();
        
        // Generate Fake Lucky Numbers locally (for fun)
        const nums = Array.from({length: 5}, () => Math.floor(Math.random() * 60) + 1).join(' - ');
        elements.luckyNumbers.innerText = nums + " - " + (Math.floor(Math.random() * 10) + 1);

        elements.result.innerHTML = DOMPurify.sanitize(marked.parse(data.content));
        
        elements.output.classList.remove('hidden');
        elements.output.scrollIntoView({ behavior: 'smooth' });
        
        await recordUsage(TOOL_ID);
        await checkUsage(TOOL_ID);

      } catch (e) {
        elements.errorMsg.innerText = e.message;
        elements.error.classList.remove('hidden');
      } finally {
        clearTimeout(longWaitTimer);
        elements.btn.disabled = false;
        elements.btnText.innerText = 'Decode Dream';
        elements.spinner.classList.add('hidden');
      }
    };
  </script>
</body>
</html>